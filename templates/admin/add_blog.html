{% extends "base.html" %}
{% block title %}Add Blog Post{% endblock %}
{% block content %}
<h1>Add Blog Post</h1>

<form method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    <div>
        {{ form.title.label }}<br>
        {{ form.title(size=50) }}
    </div>
    <div>
        {{ form.slug.label }}<br>
        {{ form.slug(size=50) }}<br>
        <small>URL-friendly version of the title (e.g., my-blog-post)</small>
    </div>
    <div>
        {{ form.excerpt.label }}<br>
        {{ form.excerpt(rows=3, cols=50) }}
    </div>
    <div>
        {{ form.content.label }}<br>
        {{ form.content(rows=15, cols=50, id="content") }}
        <button type="button" id="upload-image-btn" class="btn-secondary">Upload Image</button>
        <input type="file" id="image-upload" accept="image/*" style="display:none;">
        <small>You can use Markdown syntax. Code blocks with triple backticks will be highlighted.</small>
    </div>
    <div>
        {{ form.featured_image.label }}<br>
        {{ form.featured_image() }}<br>
        <small>Optional: Featured image for the blog card.</small>
    </div>
    <div>
        {{ form.tags.label }}<br>
        {{ form.tags(size=50) }}<br>
        <small>Comma-separated tags</small>
    </div>
    <div>
        {{ form.published() }} {{ form.published.label }}
    </div>
    <button type="submit">Add Blog Post</button>
</form>

<script>
// Inline image upload
document.getElementById('upload-image-btn').addEventListener('click', function() {
    document.getElementById('image-upload').click();
});

document.getElementById('image-upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/admin/upload-inline-image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.location) {
            const textarea = document.getElementById('content');
            const markdownImage = `![${file.name}](${data.location})`;
            // Insert at cursor position
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + markdownImage + textarea.value.substring(end);
        } else {
            alert('Upload failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Upload failed');
    });
});
</script>
{% endblock %}
